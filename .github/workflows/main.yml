name: React Native CI (Yarn 4 - Fixed)

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. 检出代码
      - uses: actions/checkout@v4

      # 2. 设置 Node.js 20 (确保自带 Corepack)
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'yarn'

      # 3. 强制安装并激活 Yarn 4 (关键修复步骤)
      - name: Install Yarn 4 via Corepack
        run: |
          # 清除可能的旧版 Yarn 残留
          npm uninstall -g yarn || true
          rm -f $(which yarn) $(which yarnpkg) || true

          # 通过 Corepack 强制激活指定版本
          corepack enable
          corepack prepare yarn@4.9.1 --activate --yes
          yarn set version 4.9.1

          # 验证安装
          echo "Yarn path: $(which yarn)"
          echo "Yarn version: $(yarn --version)"

      # 4. 显式将 Yarn 加入 PATH (保险措施)
      - name: Add Yarn to PATH
        run: |
          echo "Adding Yarn to PATH..."
          echo "$(yarn global bin)" >> $GITHUB_PATH
          echo "$HOME/.yarn/bin" >> $GITHUB_PATH

      # 5. 安装依赖 (严格模式)
      - name: Install dependencies
        run: yarn install --immutable

      # 6. 构建项目
      - name: Build project
        run: yarn build
